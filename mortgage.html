<html>
  <head>
    <title>Mortgage computations</title>
    <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.21.custom.min.js"></script>
    <script type="text/javascript" src="d3.v2.min.js"></script>
    <script type="text/javascript" src="actuaries.js"></script>
    <link type="text/css" href="css/ui-lightness/jquery-ui-1.8.21.custom.css" rel="stylesheet" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style>
  label {
    margin-right: 5px;
  }
  .input {
    border: 1px solid #ccc;
    background: #ffc;
  }
  .boxed {
    background-color: #fafafa;
    border: 1px solid #ccc;
    border-width: 1px;
    margin: 10px;
    padding: 20px;
    width: 600px;
  }
  .bold {
    color: #f6931f;
    font-weight: bold;
  }
  .boxTitle {
    display: block;
    font-weight: bold;
  }
  .boxContent {
    margin-top: 10px;
  }
  .toggle:after {
    content: " (+)";
    font-size: smaller;
    font-style: normal;
  }
  #canvas {
    height: 80px;
  }
  .axis path,
  .axis line {
    fill: none;
    stroke: black;
    stroke-width: 2px;
    shape-rendering: crispEdges;
  }
  .axis text,
  text.axis {
    font-family: sans-serif;
    font-size: 11px;
  }
  </style>
  </head>
<body>

<div id="inputs" class="boxed">
  <em class="boxTitle">Inputs</em>
  <div class="boxContent">
    <label for="amount">Amount (<span class="currency">&pound;</span>)</label>
    <input id="amount" type="text" class="input" value="80000" size="4" maxLength="6" />

    <label for="rate">Rate (%)</label>
    <input id="rate" type="text" class="input" value="3" size="2" maxLength="4"/>

    <label for="years">Years</label>
    <input id="years" type="text" class="input" value="20" size="1" maxLength="2" />

    <br><br>
    <label for="nextrate">Next rate (%)</label>
    <input id="nextrate" type="text" class="input" value="4" size="2" maxLength="4"/>

    <label for="nextrateyear">After years</label>
    <input id="nextrateyear" type="text" class="input" value="2" size="1" maxLength="2" />
    <br/><br/>
    <div id="overpaymentslider" style="margin: 10px 0; width: 50%;"></div>
    <label for="overpayment">Overpayment (<span class="currency">&pound;</span>)</label>
    <input id="overpayment" type="text" class="input" value="0" size="2" maxLength="4" />
  </div>
</div>

<div id="paymentoutputs" class="boxed">
  <em class="boxTitle">Original payment plan</em>
  <div class="boxContent">
    <span id="periods"></span> payments as follows:
    <div id="payment"></div>
  </div>
</div>

<div id="repaymentoutputs" class="boxed">
  <em class="boxTitle">Repayments</em>
  <div class="boxContent">
    Repayment will happen in <span id="actualperiods">0</span> periods (<span id="actualyears">0</span>).<br>
    After <span id="currentperiod" class="bold">24</span> periods:
    <div id="periodslider" style="margin: 10px 0; width: 50%;"></div>
    <div id="repayments"></div>
    <div id="canvas"></div>
  </div>
</div>

<div id="options" class="boxed">
  <em class="boxTitle toggle">Options</em>
  <div id="optionsbox" class="boxcontent">
    <input type="radio" name="currency" value="&pound;" checked />British Pound (&pound;)<br/>
    <input type="radio" name="currency" value="$" />US Dollar ($)<br/>
    <input type="radio" name="currency" value="&euro;" />Euro (&euro;)<br/>
  </div>
</div>

<script type="text/javascript">
"use strict";
function clamp(val, min, max) {
    if (isNaN(val) || val === "")
        val = 0;
    if (val < min)
        return min;
    if (val > max)
        return max;
    return val;
}

var minRate = 0.25;
var maxRate = 15;

var minYears = 5;
var maxYears = 40;

var amount;
var rate;
var years;
var nextrate;
var nextrateyear;
var overpayment;
var actualperiods;
var actualyears;

var currentperiod = $("#currentperiod").text();
var currency = setCurrency($("input:radio[name=currency]:checked").val());

var mortgage = new Mortgage();

$("#inputs").change(function() {

  // input data
  amount = clamp(parseInt($("#amount").val()), 10000, 1000000);
  rate = clamp(parseFloat($("#rate").val()), minRate, maxRate);
  years = clamp(parseInt($("#years").val()), minYears, maxYears);

  nextrate = clamp(parseFloat($("#nextrate").val()), minRate, maxRate);
  nextrateyear = clamp(parseInt($("#nextrateyear").val()), 0, years);

  overpayment = clamp(parseInt($("#overpayment").val()), 0, 1000);

  // computations
  mortgage.amount(amount)
          .years(years)
          .rate(rate)
          .rate(nextrate, nextrateyear)
          .overpayment(overpayment);

  var payment = mortgage.payment();
  var periods = mortgage.periods();

  actualperiods = mortgage.actualperiods();
  actualyears = Math.floor(actualperiods / 12) + " years";
  var months = actualperiods % 12;
  if (months > 0) {
    actualyears += " and " + months + " month";
    if (months > 1)
      actualyears += "s";
  }

  currentperiod = clamp(parseInt($("#currentperiod").text()), 0, actualperiods);
  updateFields(amount, rate, years, nextrate, nextrateyear,
               overpayment, actualperiods, actualyears, currentperiod);

  // report results
  $("#periods").text(mortgage.years() * 12);
  $("#payment").html($("<ul>"));
  $.each(periods, function(i) {
     $("#payment ul").append($("<li>")
                     .append(periods[i] + " payments of " + currency(payment.due[i])));
  });

  // plot
  plotRepayment("#canvas", mortgage, currentperiod);

}).change();


// options
$("#options").change(function() {
  var currencySymbol = $("input:radio[name=currency]:checked").val();
  currency = setCurrency(currencySymbol);
  $("span.currency").text(currencySymbol);
  $("#inputs").trigger("change");
}).change();

// toggle boxes
$("em.toggle + div.boxContent").hide();
$("em.toggle").click(function() {
  $(this).siblings("div.boxContent").slideToggle("fast");
});


$("#overpayment").change(function() {
  overpayment = clamp(parseInt($("#overpayment").val()), 0, 1000);
  $("#inputs").trigger("change");
}).change();

// slider
$("#periodslider").slider({ value: 24, min: 0, max: actualperiods, step: 1,
                      animate: true,
                      slide: function(event, ui) {
                               $("#currentperiod").text(ui.value);
                               $("#inputs").trigger("change");
                             }
                   });

$("#overpaymentslider").slider({ value: overpayment, min: 0, max: 1000, step: 25,
                      animate: true,
                      slide: function(event, ui) {
                               $("#overpayment").val(ui.value);
                               $("#overpayment").trigger("change");
                             }
                   });


function updateFields(amount, rate, years, nextrate, nextrateyear,
                      overpayment, actualperiods, actualyears, currentperiod) {
  $("#amount").val(amount);
  $("#rate").val(rate);
  $("#years").val(years);
  $("#nextrate").val(nextrate);
  $("#nextrateyear").val(nextrateyear);
  $("#overpayment").val(overpayment);
  $("#currentperiod").text(currentperiod);
  $("#actualperiods").text(actualperiods);
  $("#actualyears").text(actualyears);
  $("#periodslider").slider("option", "max", actualperiods);
  $("#periodslider").slider("value", currentperiod);
  $("#overpaymentslider").slider("value", overpayment);
}

</script>

</body>
</html>
